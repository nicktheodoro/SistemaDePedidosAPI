CREATE TABLE IF NOT EXISTS "__EFMigrationsHistory" (
    "MigrationId" character varying(150) NOT NULL,
    "ProductVersion" character varying(32) NOT NULL,
    CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY ("MigrationId")
);

START TRANSACTION;

-- SCRIPIT SQL IDEMPOTENTE
-- verifica internamente quais migrações já foram aplicadas (por meio da tabela de
-- histórico de migrações) e aplicam-se apenas a elas ausentes.

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    CREATE TABLE "Clientes" (
        "Id" integer GENERATED BY DEFAULT AS IDENTITY,
        "Nome" VARCHAR(80) NOT NULL,
        "Phone" CHAR(11) NULL,
        "CEP" CHAR(2) NOT NULL,
        "Estado" CHAR(2) NOT NULL,
        "Cidade" character varying(70) NOT NULL,
        CONSTRAINT "PK_Clientes" PRIMARY KEY ("Id")
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    CREATE TABLE "Produtos" (
        "Id" integer GENERATED BY DEFAULT AS IDENTITY,
        "CodigoBarras" VARCHAR(14) NOT NULL,
        "Descricao" VARCHAR(60) NULL,
        "Valor" numeric NOT NULL,
        "TipoProduto" text NOT NULL,
        "Ativo" boolean NOT NULL,
        CONSTRAINT "PK_Produtos" PRIMARY KEY ("Id")
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    CREATE TABLE "Pedidos" (
        "Id" integer GENERATED BY DEFAULT AS IDENTITY,
        "ClienteId" integer NOT NULL,
        "InicadoEm" timestamp without time zone NOT NULL DEFAULT (CURRENT_TIMESTAMP),
        "FinalizadoEm" timestamp without time zone NOT NULL,
        "TipoFrete" integer NOT NULL,
        "Status" text NOT NULL,
        "Observacao" VARCHAR(512) NULL,
        CONSTRAINT "PK_Pedidos" PRIMARY KEY ("Id"),
        CONSTRAINT "FK_Pedidos_Clientes_ClienteId" FOREIGN KEY ("ClienteId") REFERENCES "Clientes" ("Id") ON DELETE CASCADE
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    CREATE TABLE "PedidoItens" (
        "Id" integer GENERATED BY DEFAULT AS IDENTITY,
        "PedidoId" integer NOT NULL,
        "ProdutoId" integer NOT NULL,
        "Quantidade" integer NOT NULL DEFAULT 1,
        "Valor" numeric NOT NULL,
        "Desconto" numeric NOT NULL,
        CONSTRAINT "PK_PedidoItens" PRIMARY KEY ("Id"),
        CONSTRAINT "FK_PedidoItens_Pedidos_PedidoId" FOREIGN KEY ("PedidoId") REFERENCES "Pedidos" ("Id") ON DELETE CASCADE,
        CONSTRAINT "FK_PedidoItens_Produtos_ProdutoId" FOREIGN KEY ("ProdutoId") REFERENCES "Produtos" ("Id") ON DELETE CASCADE
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    CREATE INDEX idx_cliente_telefone ON "Clientes" ("Phone");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    CREATE INDEX "IX_PedidoItens_PedidoId" ON "PedidoItens" ("PedidoId");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    CREATE INDEX "IX_PedidoItens_ProdutoId" ON "PedidoItens" ("ProdutoId");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    CREATE INDEX "IX_Pedidos_ClienteId" ON "Pedidos" ("ClienteId");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20211001234427_PrimeiraMigracao') THEN
    INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
    VALUES ('20211001234427_PrimeiraMigracao', '5.0.10');
    END IF;
END $EF$;
COMMIT;

